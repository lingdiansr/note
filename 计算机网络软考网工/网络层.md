# 计算机网络/软考网工-笔记-数据链路层

## 网络层基本概念

### 网络层提供的两种服务

1. 面向连接vs无连接
2. 可靠交付在网络vs在端系统

两种观点：

- 面向连接的可靠交付
- 无连接的、尽最大努力交付的数据报服务，不提供服务质量的承诺

#### 虚电路服务（可靠传输）

通讯之前先建立虚电路VC（逻辑上的连接），以保证双发通讯所需的一切网络资源，分组都沿着这条逻辑连接按照存储转发的方式传送。

#### 数据报服务（尽力而为）

网络发送分组时不需要先建立连接。每个分组独立发送，与前后分组无关（不进行编号）。不提供服务质量的承诺。发送的分组可能按照不同的路径传送。

#### 两种服务的对比

![image-20250415090824471](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415090824471.png)

**注意**：交换方式有区分，电路交换、报文交换、分组交换。（两种服务都属于分组交换。）

### 网络层的两个工作层面

路由器之间传递的信息主要有**数据**和**路由信息**两大类。

#### 数据层面和控制层面

![image-20250415091522300](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415091522300.png)

数据层面：

- 路由器根据本路由器生成的转发表，把收到的分组从查找到的对应接口转发出去。
- 独立工作。
- 采用硬件进行转发，快。

控制层面：

- 根据路由选择协议所用的路由算法计算路哟欧，创建出本路由器的路由表，下发至转发表。
- 许多路由器协同动作。
- 采用软件计算，慢。

#### 软件定义网络SDN

SDN（Software Defined Network）

控制层面由集中控制器统一对所有的路由器的路由表进行管控。

![image-20250415092132770](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415092132770.png)

## IP地址

| -          | IPv4   | IPV6     | MAC      |
| ---------- | ------ | -------- | -------- |
| 二进制位数 | 32     | 128      | 48       |
| 表示方式   | 十进制 | 十六进制 | 十六进制 |

### IP地址概述

32位二进制，有网络号和主机号组成，采用点分十进制表示。

 192.168.1.12/24：前缀长度

192.168.1.12 255.255.255.0：子网掩码

表示网络号位数

- 192.168.1.0/24 网络号
- 192.168.1.255/24 广播地址
- 192.168.1.1~254/24 可用ip

#### 早期IP地址分类

![image-20250415093449138](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415093449138.png)

私有地址：

10.0.0.0

172.16.0.0/16～172.31.0.0/16

192.168.0.0 /24～192.168.255.0/24

#### 无分类编址CIDR

CIDR（Classless Inter-Domain Routing）:无分类域间路由选择。

根据前缀长度确定网络号。

ip地址划分为网络前缀，主机号

### 子网划分

#### 等长子网

从主机位借位作为子网号，每个子网主机数量相同。

例如：

192.168.100.0/24网络号划分4个子网，每个子网等长，则可划分为

1. 192.168.100.0/26
2. 192.168.100.64/26
3. 192.168.100.128/26
4. 192.168.100.192/26 

#### 变长子网

每个子网容纳的主机数不同。

例如： 

将192.168.100.0/24网络号划分为三个子网,这三个子网的主机数量分别为： 部门A(40)、部门B(12)、部门C(75)

![image-20250415103603373](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415103603373.png)

![image-20250415103652492](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415103652492.png)

![image-20250415103800277](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415103800277.png) 

![image-20250415103912727](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415103912727.png)

### 路由聚合

把多个子网汇总成一个大的网络号。

找出多个子网络的最长共同体，即是汇总后的网络号。

![image-20250415104214123](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415104214123.png)

前六位都是相同的，故8+8+6=22

### IP地址与MAC地址的区别

![image-20250415104436728](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415104436728.png)

## IP协议

### IP数据报的首部

![image-20250415105816791](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415105816791.png)

- 固定首部 ：20字节 
- 版本：4 首部长度：5（以4字节为单位）
-  区分服务：数据包的服务级别 
- 总长度：首部与数据之和 65535/64 K
- 标识：识别号，区分不同的IP包 
- 标志：DF禁止分片、MF 更多分片 
- 片偏移：占 13 位，某片在原分组中 的相对位置，以 8 个字节为偏移单位 
- 生存时间：TTL， 标明该数据包可通 过的路由器数的最大值 ，小于等于255
- 协议号：标识上层的承载对象 TCP=6,UDP=17
- 首部校验和：对首部进行校验计算, ipv6没有校验

### IP数据报分片

![image-20250415111208678](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415111208678.png)

MTU最大传输单元是1500,包含首部，所以数据部分最大为1480字节。

![image-20250415111311261](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415111311261.png)

IP**包的重组在最终目的地完成**。

​	注意分片后数据长度应当为8的倍数，以便描述片偏移地址。

### TTL生存时间

- windows初始TTL为128, win10以后为64
- linux初始TTL为64
- 决定数据报的传播距离，每经过一个三层设备就减一
- 三层放环
- Tracert/traceroute 跟踪路径

### 常见协议号

![image-20250415112435401](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415112435401.png)

### 首部校验和

采用反码求和简单算法。进位从最高位回滚（回卷）到最低位相加

发送端将检验和初始置为全0,按照16位二进制对齐求和后取反码作为检验和。

接收就按照同样方法，得出最终求和取反码结果为0则校验通过，否则丢弃。

数据报每经过一个路由器都要重新计算首部校验和。

## ARP协议

## ICMP协议

## OSPF路由协议

###  OSPF协议的特点

- OSPF把自治系统AS（Autonomous System）划分成逻辑意义上的一个或多个区域； 
- OSPF通过LSA（Link State Advertisement）的形式发布路由； 
- OSPF依靠在OSPF区域内各设备间交互OSPF报文来达到路由信息的统一； 
-  OSPF报文封装在IP报文内(协议号89)，可以采用单播或组播的形式发送。主要采用组播方式，组播地址为224.0.0.5、224.0.0.6，周知组播，TTL=1，不能穿过路由。

AS：一个单位管理的网络范围，具有相同路由管理策略或者路由协议。

AS内路由（IGP内部网关协议）：RIP、OSPF、IS-IS

AS间路由（EGP外部网关协议）：BGP（边界网关协议）

封装方式对比：

- RIP：ip中的udp（标识17）中的rip（端口520）
- ospf：ip中的ospf（标识89）
- BGP：ip中的tcp（标识6）中的bgp（端口179）
- IS-IS：802.3帧

OSPF不广播：NBMA非广播多路访问网，（帧中继）。ospf邻居为手工指定，只能采用单播方式传播报文。

### 链路状态路由协议工作过程

![image-20250415115732759](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415115732759.png)

1. 建立相邻路由器之间的**邻居关系**。
2. 邻居之间通过发送发送LSA交换链路状态信息和同步**LSDB**（链路状态数据库） 
3. 进行**优选路径**计算
4. 根据最短路径树生成路由表项加载到路由表。



### OSPF三大表

OSPF邻居表、LSDB表、OSPF路由表

#### 邻居表

- OSPF在传递链路状态信息之前，需先建立OSPF邻居关系。
- OSPF的邻居关系通过交互Hello报文建立
- OSPF邻居表显示了OSPF路由器之间的邻居状态
- 使用`dispaly ospf peer`查看。

![image-20250415165621921](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415165621921.png)

10s 发一次Hello报文，40s没有回应认为邻居失效

#### LSDB表

![image-20250415170058276](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415170058276.png)

- LSDB会保存自己生产的从及邻居收到的LSA信息，本例中的R1的LSDB包含了三条LSA
- 只维护本区域LSDB，区域之间交换路由信息而不是链路状态信息
- Type：LSA的类型；AdvRouter：发送LSA的路由器

#### OSPF路由表

![image-20250415184646215](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415184646215.png)

- OSPF路由表和路由器路由表是两张不同的表。本例中OSPF路由比安排有三条路由。
- OSPF路由表包含Destination、Cost和NextHop等指导转发的信息。
- 使用命令`display ospf routing`

### OSPF协议报文类型 

|         OSPF 报文类型         |                             作用                             |
| :---------------------------: | :----------------------------------------------------------: |
|             Hello             |                      建立并维护邻居关系                      |
|  Database Description（DD）   | 数据库内容的摘要，用于数据库同步；包含LSA的头部信息，用来描述LSDB摘要 |
|  Link State  Request（LSR）   |        请求自己没有的或者比自己更新的链路状态详细信息        |
|   Link State Update（LSU）    |               链路状态更新信息(LSA 头部和内容)               |
| Link State Acknowledge(LSAck) |                        对 LSU 的确认                         |

### 邻居状态机

![image-20250415191749304](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415191749304.png)

- Down：这是邻居的初始状态，还没收到Hello报文 
- Attempt：只在NBMA网络上存在，已发出Hello报文，但没收 到回复 
- Init：已经从邻居收到了Hello报文，但报文邻居列表没有自己 的router-id 
- **2-Way**：互相收到了对方的Hello报文，并且报文邻居列表有 自己的router-id ，进入邻居状态。稳定态
- ExStart：向邻居发送DD报文，协商主从关系 
- Exchange：相互发送包含链路状态信息摘要的DD报文 
- Loading：相互发送LSR报文请求LSA，发送LSU报文通告 LSA。 
- **Full**：路由器的LSDB已经同步，稳定太

DR、BDR和非DR之间建立邻接关系，非DR之间建立邻居关系。

### RouterID、邻居、邻接

RouterID是一个32位值，唯一标识，需要制定。否则使用全局RouterID。

全局RouterID选择优先级：第一个接口的IP>最大的环回口ip>最大物理地址接口ip

邻居：达成2-way态。

邻接：成功交换DD、同步LSDB后才是邻接关系。

### 邻居的发现

hello报文格式：

![image-20250415193345383](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415193345383.png)

验证一个接收到的Hello报文是否合法包括：

1. 如果接收端口的网络类型是广播型，点到多点 或者NBMA，所接收的Hello报文中Network Mask字段必须和接收端口的网络掩码一致， 如果接收端口的网络类型为点到点类型或者是 虚连接，则不检查Network Mask字段； 
2.  所接收的Hello报文中Hello Interval字段必须和 接收端口的配置一致；
3. 接收的Hello报文中Router Dead Interval字 段必须和接收端口的配置一致； 
4.  所接收的Hello报文中Options字段中的E-bit （表示是否接收外部路由信息）必须和相关区 域的配置一致

- Hello Interval一般网络为10s.

- Router Priority 路由优先级，用于竞选DR和BDR

- Router Dead interval hello老化时间

### 同步数据库

![image-20250415203623476](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415203623476.png)

- 1、2号报文为空DD报文，用于协商主从，router-id大胜出
- 3、4号报文包含LSDB摘要信息
- 5号也是空DD, 用于对DR的DD报文确认。

注意：DD报文中的interface MTU两端需要一致。思科设备强制校验，华为可设置开启。

### 建立完全邻接关系

![image-20250416151430311](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250416151430311.png)

- LSR用于向对方请求所需的LSA。 
- LSU用于向对方发送其所需要的LSA。 
- LSACK用于向对方发送收到LSA的确认。

LSR中携带了LSA的头部信息。

### DR与BDR的产生背景  

MA多路访问网络有两种类型：广播型多路访问网络BMA和非广播型多路访问网络NBMA，以太网是一种典型的BMA。

如果每台路由器之间都建立OSPF邻接关系，会导致OSPF邻接关系大量冗余，洪泛的OSPF报文占用大量网络带宽资源。

通过设置路由器身份：DR、BDR、DRother，使非指定路由只与DR和BDR建立邻接关系，大大减少资源消耗。

通过发送Hello报文，比较其中的优先级和RouterID选举，越大越优；优先级为零则不参与选举。

DR和BDR不抢占，只在启动和原DR失效时进行选举，原DR失效时原BDR成为DR并重新选举BDR。

启动时等待30S认为自己是DR ，其他路由器在30s后启动的也无法成为DR。

### OSPF支持的网络类型

- 点到点网络

- 广播型网络

- NBMA网络

- 点到多点网络

  

缺省认为以太网为广播型，PPP、HDLC 为点到点型，帧中继、ATM的网络类型是NBMA 。

没有链路层协议会被认为是P2MP。

| 网络类型       | HELLO | DEAD | HELLO 报文更新方式 | 邻居建立方式 | 是否选举DR/BDR |
| -------------- | ----- | ---- | ------------------ | ------------ | -------------- |
| 广播类型       | 10s   | 40s  | 组播               | 自动发现     | 是             |
| 点到点         | 10s   | 40s  | 组播               | 自动发现     | 否             |
| 非广播多路访问 | 30s   | 120s | 单播               | 手工指定     | 是             |
| 点到多点       | 30s   | 120s | 组播               | 自动发现     | 否             |

| 路由协议 | HELLO | DEAD |
| -------- | ----- | ---- |
| RIP      | 30s   | 180s |
| IS-IS    | 10s   | 30s  |
| BGP      | 60s   | 180s |

### OSPF 区域

通过限制区域规模减少LSA报文的资源占用。

- 每个区域都维护一个独立的LSDB

- Area 0 是骨干区域，其他区域都必须与此区域相连。防止环路。

- 划分OSPF区域可以缩小 路由器的LSDB规模，减少网络流量。

- 区域内的详细脱不信息不向其他区域放松，区域间传递的是抽象的路由信息。

  

ABR与ASBR:

- ABR是区域边界路由器，连接两个区域
- ASBR是自治系统边界路由器，连接两个自治系统

#### 区域的分类

| 区域类型         | 作用                                                         |
| ---------------- | ------------------------------------------------------------ |
| 普通区域         | 缺省情况下，OSPF区域被定义为普通区域。<br />**接受所有类型LSA** |
| STUB区域         | 不允许发布自治系统外部路由，只允许发布区域内路由和区域间的路由。<br />**只接收1类、2类、3类LSA** |
| Totally STUB区域 | 不允许发布自治系统外部路由和区域间的路由，只允许发布区域内路由。<br />**只接收1类、2类LSA** |
| NSSA区域         | 该区域既保留自治系统内的STUB区域的特征，又需要引入外部路由。<br />**生成7类LSA，只接收1类、2类、3类LSA** |
| Totally NSSA区域 | 该区域既保留自治系统内的Totally STUB Area区域的特征，又需要引入外部路由。<br />**生成7类LSA，只接收1类、2类LSA** |

### LSA类型

| LSA类型                       | LSA作用                                                      |
| ----------------------------- | ------------------------------------------------------------ |
| Router-LSA（Type1）           | 每个设备都会产生，描述了设备的链路状态和开销，在所属的区域内传播。 |
| Network-LSA（Type2）          | 由DR（Designated Router）产生，描述本网段的链路状态，在所属的区 域内传播。 |
| Network-summary-LSA （Type3） | 由ABR产生，描述区域内某个网段的路由，并通告给其它区域。      |
| ASBR-summary-LSA （Type4）    | 由ABR产生，描述到ASBR的路由，通告给除ASBR所在区域的其他相关区 域。 |
| AS-external-LSA（Type5）      | 由ASBR产生，描述到AS外部的路由，通告到所有的区域（除了STUB区 域和ESSA区域）。 |
| NSSA LSA（Type7）             | 由ASBR产生，描述到AS外部的路由，仅在NISSA区域内传播。        |

| 级别 |           名称            |  发起路由  |        洪泛范围        |                作用                |
| :--: | :-----------------------: | :--------: | :--------------------: | :--------------------------------: |
|  1   |   Router LSA(路由器LSA)   | OSPF路由器 |         区域内         |      描述路由器的直连拓扑信息      |
|  2   |   Network LSA(网络LSA)    |     DR     |         区域内         | 描述多路访问网络DR邻接的一组路由器 |
|  3   |   Summary LSA(汇总LSA)    |    ABR     |         区域内         |        描述区域间的路由信息        |
|  4   |         ASBR LSA          |    ABR     |         区域内         |       描述区域间ASBR的可达性       |
|  5   | External LSA(外部路由LSA) |    ASBR    | OSPF路由域(除特殊区域) |          描述OSPF外部路由          |
|  7   |         NSSA LSA          | NSSA ASBR  |         区域内         |     描述NSSA区域的OSPF外部路由     |

### OSPF路由类型

路由冲突时按优先级处理，越先越优。

1. 区域内路由
2. 区域间路由
3. AS外部路由
   1. 一类外部路由：加内部开销
   2. 二类外部路由：不加内部开销

### OSPF路由聚合

是指ABR可以将具有相同前缀的路由信息聚合到一起，执法不一条路由到其他区域。区域间通过路由聚合，减少路由信息， 从而减小路由表的规模，提高设备的性能。

1. ABR聚合：ABR向其它区域发送路由信息时，以网段为单位生成Type3 LSA。
2. ASBR聚合：配置路由聚合后，如果本地设备是自治系统边界路由器ASBR，将对引入的聚合 地址范围内的Type5 LSA进行聚合。

### OSPF缺省路由

缺省路由是指目的地址和掩码都是0的路由。当设备无精确匹配的路由时，就可以通过缺省路由进行报文转发。 由于OSPF路由的分级管理，Type3缺省路由的优先级高于Type5或Type7路由。 

1. 由区域边界路由器（ABR）发布Type3缺省Summary LSA，用来指导区域内设备进行区域之间报文的 转发。 
2. 由自治系统边界路由器（ASBR）发布Type5外部缺省ASE LSA，或者Type7外部缺省NSSA LSA，用来 指导自治系统（AS）内设备进行自治系统外报文的转发。

 注：OSPF路由器只有具有对区域外的出口时，才能够发布缺省路由LSA。

### OSPF基本配置

