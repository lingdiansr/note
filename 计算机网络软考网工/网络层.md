# 计算机网络/软考网工-笔记-数据链路层

## 网络层基本概念

### 网络层提供的两种服务

1. 面向连接vs无连接
2. 可靠交付在网络vs在端系统

两种观点：

- 面向连接的可靠交付
- 无连接的、尽最大努力交付的数据报服务，不提供服务质量的承诺

#### 虚电路服务（可靠传输）

通讯之前先建立虚电路VC（逻辑上的连接），以保证双发通讯所需的一切网络资源，分组都沿着这条逻辑连接按照存储转发的方式传送。

#### 数据报服务（尽力而为）

网络发送分组时不需要先建立连接。每个分组独立发送，与前后分组无关（不进行编号）。不提供服务质量的承诺。发送的分组可能按照不同的路径传送。

#### 两种服务的对比

![image-20250415090824471](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415090824471.png)

**注意**：交换方式有区分，电路交换、报文交换、分组交换。（两种服务都属于分组交换。）

### 网络层的两个工作层面

路由器之间传递的信息主要有**数据**和**路由信息**两大类。

#### 数据层面和控制层面

![image-20250415091522300](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415091522300.png)

数据层面：

- 路由器根据本路由器生成的转发表，把收到的分组从查找到的对应接口转发出去。
- 独立工作。
- 采用硬件进行转发，快。

控制层面：

- 根据路由选择协议所用的路由算法计算路哟欧，创建出本路由器的路由表，下发至转发表。
- 许多路由器协同动作。
- 采用软件计算，慢。

#### 软件定义网络SDN

SDN（Software Defined Network）

控制层面由集中控制器统一对所有的路由器的路由表进行管控。

![image-20250415092132770](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415092132770.png)

## IP地址

| -          | IPv4   | IPV6     | MAC      |
| ---------- | ------ | -------- | -------- |
| 二进制位数 | 32     | 128      | 48       |
| 表示方式   | 十进制 | 十六进制 | 十六进制 |

### IP地址概述

32位二进制，有网络号和主机号组成，采用点分十进制表示。

 192.168.1.12/24：前缀长度

192.168.1.12 255.255.255.0：子网掩码

表示网络号位数

- 192.168.1.0/24 网络号
- 192.168.1.255/24 广播地址
- 192.168.1.1~254/24 可用ip

#### 早期IP地址分类

![image-20250415093449138](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415093449138.png)

私有地址：

10.0.0.0

172.16.0.0/16～172.31.0.0/16

192.168.0.0 /24～192.168.255.0/24

#### 无分类编址CIDR

CIDR（Classless Inter-Domain Routing）:无分类域间路由选择。

根据前缀长度确定网络号。

ip地址划分为网络前缀，主机号

### 子网划分

#### 等长子网

从主机位借位作为子网号，每个子网主机数量相同。

例如：

192.168.100.0/24网络号划分4个子网，每个子网等长，则可划分为

1. 192.168.100.0/26
2. 192.168.100.64/26
3. 192.168.100.128/26
4. 192.168.100.192/26 

#### 变长子网

每个子网容纳的主机数不同。

例如： 

将192.168.100.0/24网络号划分为三个子网,这三个子网的主机数量分别为： 部门A(40)、部门B(12)、部门C(75)

![image-20250415103603373](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415103603373.png)

![image-20250415103652492](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415103652492.png)

![image-20250415103800277](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415103800277.png) 

![image-20250415103912727](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415103912727.png)

### 路由聚合

把多个子网汇总成一个大的网络号。

找出多个子网络的最长共同体，即是汇总后的网络号。

![image-20250415104214123](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415104214123.png)

前六位都是相同的，故8+8+6=22

### IP地址与MAC地址的区别

![image-20250415104436728](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415104436728.png)

## IP协议

### IP数据报的首部

![image-20250415105816791](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415105816791.png)

- 固定首部 ：20字节 
- 版本：4 首部长度：5（以4字节为单位）
-  区分服务：数据包的服务级别 
- 总长度：首部与数据之和 65535/64 K
- 标识：识别号，区分不同的IP包 
- 标志：DF禁止分片、MF 更多分片 
- 片偏移：占 13 位，某片在原分组中 的相对位置，以 8 个字节为偏移单位 
- 生存时间：TTL， 标明该数据包可通 过的路由器数的最大值 ，小于等于255
- 协议号：标识上层的承载对象 TCP=6,UDP=17
- 首部校验和：对首部进行校验计算, ipv6没有校验

### IP数据报分片

![image-20250415111208678](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415111208678.png)

MTU最大传输单元是1500,包含首部，所以数据部分最大为1480字节。

![image-20250415111311261](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415111311261.png)

IP**包的重组在最终目的地完成**。

​	注意分片后数据长度应当为8的倍数，以便描述片偏移地址。

### TTL生存时间

- windows初始TTL为128, win10以后为64
- linux初始TTL为64
- 决定数据报的传播距离，每经过一个三层设备就减一
- 三层放环
- Tracert/traceroute 跟踪路径

### 常见协议号

![image-20250415112435401](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415112435401.png)

### 首部校验和

采用反码求和简单算法。进位从最高位回滚（回卷）到最低位相加

发送端将检验和初始置为全0,按照16位二进制对齐求和后取反码作为检验和。

接收就按照同样方法，得出最终求和取反码结果为0则校验通过，否则丢弃。

数据报每经过一个路由器都要重新计算首部校验和。

## ARP协议

## ICMP协议

## OSPF路由协议

###  OSPF协议的特点

- OSPF把自治系统AS（Autonomous System）划分成逻辑意义上的一个或多个区域； 
- OSPF通过LSA（Link State Advertisement）的形式发布路由； 
- OSPF依靠在OSPF区域内各设备间交互OSPF报文来达到路由信息的统一； 
-  OSPF报文封装在IP报文内(协议号89)，可以采用单播或组播的形式发送。主要采用组播方式，组播地址为224.0.0.5、224.0.0.6，周知组播，TTL=1，不能穿过路由。

AS：一个单位管理的网络范围，具有相同路由管理策略或者路由协议。

AS内路由（IGP内部网关协议）：RIP、OSPF、IS-IS

AS间路由（EGP外部网关协议）：BGP（边界网关协议）

封装方式对比：

- RIP：ip中的udp（标识17）中的rip（端口520）
- ospf：ip中的ospf（标识89）
- BGP：ip中的tcp（标识6）中的bgp（端口179）
- IS-IS：802.3帧

OSPF不广播：NBMA非广播多路访问网，（帧中继）。ospf邻居为手工指定，只能采用单播方式传播报文。

### 链路状态路由协议工作过程

![image-20250415115732759](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415115732759.png)

1. 建立相邻路由器之间的**邻居关系**。
2. 邻居之间通过发送发送LSA交换链路状态信息和同步**LSDB**（链路状态数据库） 
3. 进行**优选路径**计算
4. 根据最短路径树生成路由表项加载到路由表。



### OSPF三大表

OSPF邻居表、LSDB表、OSPF路由表

#### 邻居表

- OSPF在传递链路状态信息之前，需先建立OSPF邻居关系。
- OSPF的邻居关系通过交互Hello报文建立
- OSPF邻居表显示了OSPF路由器之间的邻居状态
- 使用`dispaly ospf peer`查看。

![image-20250415165621921](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415165621921.png)

#### LSDB表

![image-20250415170058276](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/image-20250415170058276.png)

- 会保存自己生产的从及邻居收到的LSA信息，本例中的R1的LSDB包含了三条LSA
- 只维护LSA，区域之间交换路由信息
- Type：LSA的类型；AdvRouter：发送LSA的路由器

